<!DOCTYPE html>
<html>
  <head>
    <title>"Topo renderer"</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <style>
    canvas:focus {
      outline: none;
    }

    html body {
      margin: 0px;
      font-family: "Calibri", "Arial", sans-serif;
      display: flex;
      justify-content: center;
      overflow: hidden;
    }

    .root {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .main-menu {
      position: absolute;
      bottom: 0;
      padding: 1em;
    }

    .main-menu:focus-within {
      background-color: white;
    }

    .main-menu > .expanded-menu {
      display: none;
      pointer-events: none;
    }

    .main-menu:focus-within > .expanded-menu {
      display: block;
      pointer-events: unset;
    }

    .info {
      position: absolute;
      bottom: 0;
      right: 0;
      padding: 1em;
    }

    .info:focus-within {
      background-color: white;
    }

    .info > .expanded-info {
      display: none;
      pointer-events: none;
    }

    .info:focus-within > .expanded-info {
      display: unset;
      pointer-events: unset;
    }

    .info-button-container {
      float: right;
    }

    .main-canvas {
      margin: 0;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .additionalFonts {
      width: 50px;
    }

    menu {
      padding-left: 0;
      margin-top: 0;
      margin-bottom: 0;
      list-style-type: none;
    }

    li {
      margin-top: 0.4em;
      margin-bottom: 0.4em;
      padding-top: 0.2em;
      padding-bottom: 0.2em;
    }

    button {
      font-size: 20px;
    }

    a:link {
      color: black;
      text-decoration: underline;
    }

    a:visited {
      color: black;
      text-decoration: underline;
    }

    a:focus {
      text-decoration: underline;
    }

    a:hover {
      text-decoration: underline;
    }

    a:active {
      text-decoration: underline;
    }

    #status {
      display: none;
    }

    .status-bar {
      position: absolute;
      top: 0px;
      height: 50px;
    }

    .status-bar:has(#status:empty) {
      display: none;
    }

    @property --phase {
      syntax: "<angle>";
      inherits: false;
      initial-value: 0deg;
    }

    .loader > span {
      --phase: 0deg;
      height: 40px;
      width: 10px;
      display: inline-grid;
      background-color: black;
      animation: load-anim 2s linear infinite;
    }

    .loader > span:nth-child(1) {
      transform: scaleY(calc(cos(var(--phase))));
    }

    .loader > span:nth-child(2) {
      transform: scaleY(calc(cos(var(--phase) + 30deg)));
    }

    .loader > span:nth-child(3) {
      transform: scaleY(calc(cos(var(--phase) + 60deg)));
    }

    .loader > span:nth-child(4) {
      transform: scaleY(calc(cos(var(--phase) + 90deg)));
    }

    .loader > span:nth-child(5) {
      transform: scaleY(calc(cos(var(--phase) + 120deg)));
    }

    @keyframes load-anim {
      to {
        --phase: 360deg;
      }
    }

    #toast {
      padding: 10px;
      background-color: #911;
      color: #fff;
      text-align: center;
      border-radius: 2px;

      position: absolute;
      z-index: 1;
      left: 50%;
      top: 30px;
      font-size: 17px;
      white-space: nowrap;
      transform: translate(-50%, 50%);
    }

    #toast:has(#toast-desc:empty) {
      visibility: hidden;
    }

    #toast > #desc {
      color: #fff;

      padding: 16px;

      overflow: hidden;
      white-space: nowrap;
    }

    #toast > .next {
      display: none;
    }

    #toast > button {
      font-size: 12px;
    }
    </style>
  </head>
  <body>
    <div class="root">
      <canvas class="main-canvas" id="canvas"></canvas>
      <div class="info">
        <div class="expanded-info">
          Use WASD or arrows to move forward/left/backward/right, shift/space
          for up/down, Q/E to zoom in/out, right click and move mouse to rotate
          the viewpoint, ctrl and move mouse to change the light direction. <br>
          Enter latitude+longitude (as numbers from -90 to 90 for S-N and -180
          to 180 for W-E) and press "Go" (or enter). <br>
          Some peak labels might not render correctly, use "Load additional
          fonts" to fetch additional fonts (Arabic, Chinese, Japanese, Korean)
          from fonts.google.com
          <br>
          <br>
          <strong>Data sources:</strong>
          <ul>
            <li>
              Copernicus GLO-90 Digital Elevation Model via
              <a
                href="https://portal.opentopography.org/raster?opentopoID=OTSDEM.032021.4326.1"
                >opentopography.org</a
              >,<a
                href="https://docs.sentinel-hub.com/api/latest/static/files/data/dem/resources/license/License-COPDEM-30.pdf"
                >license</a
              >
            </li>
            <li>
              OpenStreetMap peaks data (via
              <a href="https://planet.openstreetmap.org/"
                >https://planet.openstreetmap.org/</a
              >, date of access: 2025-04-28)
            </li>
          </ul>
        </div>
        <div class="info-button-container">
          <button>info</button>
        </div>
      </div>
      <div class="main-menu">
        <div class="expanded-menu">
          <h2>Topo renderer</h2>
          <menu class="expanded-menu">
            <li>
              <form id="locationSelect">
                <label for="latitude">Latitude:</label>
                <input
                  type="number"
                  id="latitude"
                  name="latitude"
                  step="any"
                  required
                >
                <label for="longitude">Longitude:</label>
                <input
                  type="number"
                  id="longitude"
                  name="longitude"
                  step="any"
                  required
                >
                <input type="submit" value="Go">
              </form>
            </li>
            <li>
              <input
                id="additionalFonts"
                type="button"
                value="Load additional fonts"
              >
            </li>
          </menu>
        </div>
        <button>menu</button>
      </div>
      <div class="status-bar">
        <!--<div class="loader"></div>-->
        <div class="loader">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span id="status"></span>
      </div>
    </div>
    <div id="toast">
      <span id="toast-count">0</span>
      <span id="toast-desc"></span>
      <button id="toast-close-btn">close</button>
    </div>

    <script type="module">
    import init from "./pkg/topo_renderer_web.js";
    import { set_location, load_fonts } from "./pkg/topo_renderer_web.js";

    async function run() {
      await init();
    }

    document
      .getElementById("locationSelect")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        var formData = new FormData(e.target);

        set_location(formData.get("latitude"), formData.get("longitude"));
      });

    document.getElementById("additionalFonts").onclick = function () {
      load_fonts();
    };

    document.getElementById("toast-close-btn").onclick = function () {
      var toast = document.getElementById("toast");
      var toast_desc = document.getElementById("toast-desc");
      var next = toast.getElementsByClassName("next")[0];
      if (next) {
        toast_desc.innerHTML = next.innerHTML;
        next.remove();
      } else {
        toast_desc.innerHTML = "";
      }
      document.getElementById("toast-count").innerHTML -= 1;
    };

    run();
    </script>
  </body>
</html>
